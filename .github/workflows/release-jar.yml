name: Build and Release JAR

on:
  push:
    tags:
      - 'v*-java'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0-java)'
        required: true
        default: 'v1.0.0-java'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Build JAR with Maven
        run: |
          cd java-version
          mvn clean package -DskipTests -B

          # Create distribution directory
          mkdir -p ../dist/jar

          # Copy JAR file
          cp target/*.jar ../dist/jar/nodejs-argo-${{ steps.version.outputs.VERSION }}.jar

          # Create checksums
          cd ../dist/jar
          sha256sum *.jar > SHA256SUMS.txt

      - name: Create source package
        run: |
          mkdir -p dist/source/nodejs-argo-java-${{ steps.version.outputs.VERSION }}
          cp -r java-version/* dist/source/nodejs-argo-java-${{ steps.version.outputs.VERSION }}/

          cd dist/source
          tar -czf ../nodejs-argo-java-${{ steps.version.outputs.VERSION }}-source.tar.gz nodejs-argo-java-${{ steps.version.outputs.VERSION }}
          zip -r ../nodejs-argo-java-${{ steps.version.outputs.VERSION }}-source.zip nodejs-argo-java-${{ steps.version.outputs.VERSION }}

      - name: Generate release notes
        id: release_notes
        run: |
          cat << 'EOF' > release_notes.md
          ## ğŸš€ Release ${{ steps.version.outputs.VERSION }} (Java ç‰ˆæœ¬)

          ### ğŸ“¦ ä¸‹è½½ JAR æ–‡ä»¶ï¼ˆæ¨èï¼‰

          **éœ€è¦ Java 17 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼**

          #### å¿«é€Ÿå¼€å§‹

          ```bash
          # ä¸‹è½½ JAR æ–‡ä»¶
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/nodejs-argo-${{ steps.version.outputs.VERSION }}.jar

          # åŸºæœ¬è¿è¡Œ
          java -jar nodejs-argo-${{ steps.version.outputs.VERSION }}.jar

          # æŒ‡å®š JVM å‚æ•°ï¼ˆç±»ä¼¼å®¹å™¨å¯åŠ¨æ–¹å¼ï¼‰
          java -Xms128M -XX:MaxRAMPercentage=85.0 -jar nodejs-argo-${{ steps.version.outputs.VERSION }}.jar

          # ä½¿ç”¨ç¯å¢ƒå˜é‡æŒ‡å®šç«¯å£å’Œé…ç½®
          SERVER_PORT=8080 UUID=your-uuid NEZHA_SERVER=your-server java -jar nodejs-argo-${{ steps.version.outputs.VERSION }}.jar

          # åå°è¿è¡Œ
          nohup java -Xms128M -XX:MaxRAMPercentage=85.0 -jar nodejs-argo-${{ steps.version.outputs.VERSION }}.jar > app.log 2>&1 &
          ```

          ### ğŸ“ ä»æºç æ„å»º

          ```bash
          # ä¸‹è½½å¹¶è§£å‹æºç åŒ…
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/nodejs-argo-java-${{ steps.version.outputs.VERSION }}-source.tar.gz
          tar -xzf nodejs-argo-java-${{ steps.version.outputs.VERSION }}-source.tar.gz
          cd nodejs-argo-java-${{ steps.version.outputs.VERSION }}

          # ä½¿ç”¨ Maven æ„å»ºå¹¶è¿è¡Œ
          mvn clean package
          java -jar target/nodejs-argo-1.0.0.jar
          ```

          ### ğŸ”§ Web é…ç½®ç•Œé¢

          **æ–°åŠŸèƒ½ï¼** æœ¬ç‰ˆæœ¬æ”¯æŒé€šè¿‡ Web ç•Œé¢é…ç½®ç¯å¢ƒå˜é‡ï¼š

          1. å¯åŠ¨åº”ç”¨åè®¿é—®ï¼š`http://localhost:3000/config`
          2. åœ¨ Web ç•Œé¢ä¿®æ”¹ç¯å¢ƒå˜é‡
          3. ä¿å­˜é…ç½®åˆ° `./tmp/.env` æ–‡ä»¶
          4. é‡å¯åº”ç”¨ä½¿é…ç½®ç”Ÿæ•ˆï¼ˆé…ç½®ä¼šè‡ªåŠ¨åŠ è½½ï¼‰

          ### ğŸ“ æ”¯æŒçš„ç¯å¢ƒå˜é‡

          | å˜é‡å | è¯´æ˜ |
          |--------|------|
          | `UUID` | ç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼ˆå¿…å¡«ï¼‰ |
          | `NEZHA_SERVER` | å“ªå’æœåŠ¡å™¨åœ°å€ |
          | `NEZHA_PORT` | å“ªå’ç«¯å£ï¼ˆv0 éœ€è¦ï¼‰ |
          | `NEZHA_KEY` | å“ªå’å¯†é’¥ |
          | `ARGO_DOMAIN` | Argo å›ºå®šéš§é“åŸŸå |
          | `ARGO_AUTH` | Argo è®¤è¯ä¿¡æ¯ |
          | `CFIP` | CF ä¼˜é€‰ IP/åŸŸå |
          | `CFPORT` | CF ä¼˜é€‰ç«¯å£ |
          | `UPLOAD_URL` | èŠ‚ç‚¹ä¸Šä¼ åœ°å€ |
          | `PROJECT_URL` | é¡¹ç›® URL |
          | `NAME` | èŠ‚ç‚¹åç§° |

          ### ğŸ“‚ Release èµ„äº§è¯´æ˜

          - **JAR æ–‡ä»¶**ï¼šSpring Boot å¯æ‰§è¡Œ JARï¼Œéœ€è¦ Java 17+ ç¯å¢ƒ
            - `nodejs-argo-*-java.jar` - Java å¯æ‰§è¡Œ JAR æ–‡ä»¶
          - **æºç åŒ…**ï¼šéœ€è¦ Maven å’Œ Java ç¯å¢ƒ
            - `nodejs-argo-java-*-source.tar.gz` - æºç åŒ…ï¼ˆtar.gzï¼‰
            - `nodejs-argo-java-*-source.zip` - æºç åŒ…ï¼ˆzipï¼‰
          - **æ ¡éªŒæ–‡ä»¶**ï¼š
            - `SHA256SUMS.txt` - SHA256 æ ¡éªŒå’Œ

          ### ğŸ” æ–‡ä»¶æ ¡éªŒ

          ä¸‹è½½åè¯·éªŒè¯ SHA256 æ ¡éªŒå’Œï¼š
          ```bash
          sha256sum -c SHA256SUMS.txt
          ```

          ### â˜• JVM å‚æ•°è¯´æ˜

          æ¨èçš„ JVM å‚æ•°ï¼ˆç±»ä¼¼å®¹å™¨å¯åŠ¨æ–¹å¼ï¼‰ï¼š

          ```bash
          java -Xms128M -XX:MaxRAMPercentage=85.0 \
               -Djava.security.egd=file:/dev/./urandom \
               -jar nodejs-argo-${{ steps.version.outputs.VERSION }}.jar
          ```

          - `-Xms128M`: è®¾ç½®åˆå§‹å †å†…å­˜ä¸º 128MB
          - `-XX:MaxRAMPercentage=85.0`: è®¾ç½®æœ€å¤§ä½¿ç”¨ RAM çš„ç™¾åˆ†æ¯”ä¸º 85%
          - `-Djava.security.egd=file:/dev/./urandom`: åŠ å¿«å¯åŠ¨é€Ÿåº¦

          ### ğŸ“š æ›´å¤šä¿¡æ¯

          æŸ¥çœ‹ [Java README](https://github.com/${{ github.repository }}/tree/main/java-version) äº†è§£è¯¦ç»†ä½¿ç”¨è¯´æ˜ã€‚

          ---

          **æ³¨æ„**ï¼šæ­¤ç‰ˆæœ¬æ˜¯ Java Spring Boot å®ç°ï¼Œéœ€è¦ Java 17 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚å¦‚æœä½ ä¸æƒ³å®‰è£… Javaï¼Œè¯·ä½¿ç”¨ [Node.js ç‰ˆæœ¬](https://github.com/${{ github.repository }}/releases)çš„ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶ã€‚
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }} (Java)
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            dist/jar/nodejs-argo-${{ steps.version.outputs.VERSION }}.jar
            dist/jar/SHA256SUMS.txt
            dist/nodejs-argo-java-${{ steps.version.outputs.VERSION }}-source.tar.gz
            dist/nodejs-argo-java-${{ steps.version.outputs.VERSION }}-source.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
