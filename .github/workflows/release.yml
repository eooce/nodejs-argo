name: Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create distribution package
        run: |
          mkdir -p dist/nodejs-argo-${{ steps.version.outputs.VERSION }}
          cp -r index.js package.json Dockerfile LICENSE README.md dist/nodejs-argo-${{ steps.version.outputs.VERSION }}/
          cd dist
          tar -czf nodejs-argo-${{ steps.version.outputs.VERSION }}.tar.gz nodejs-argo-${{ steps.version.outputs.VERSION }}
          zip -r nodejs-argo-${{ steps.version.outputs.VERSION }}.zip nodejs-argo-${{ steps.version.outputs.VERSION }}

      - name: Generate release notes
        id: release_notes
        run: |
          cat << 'EOF' > release_notes.md
          ## ğŸš€ Release ${{ steps.version.outputs.VERSION }}

          ### ğŸ“¦ å®‰è£…æ–¹å¼

          #### ä½¿ç”¨ Docker (æ¨è)
          ```bash
          docker pull ghcr.io/${{ github.repository_owner }}/nodejs:latest
          docker run -d -p 3000:3000 \
            -e UUID=your-uuid \
            -e NEZHA_SERVER=your-server \
            -e NEZHA_KEY=your-key \
            ghcr.io/${{ github.repository_owner }}/nodejs:latest
          ```

          #### ä½¿ç”¨æºç 
          ```bash
          # ä¸‹è½½å¹¶è§£å‹
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/nodejs-argo-${{ steps.version.outputs.VERSION }}.tar.gz
          tar -xzf nodejs-argo-${{ steps.version.outputs.VERSION }}.tar.gz
          cd nodejs-argo-${{ steps.version.outputs.VERSION }}

          # å®‰è£…ä¾èµ–å¹¶è¿è¡Œ
          npm install
          npm start
          ```

          ### ğŸ”§ Web é…ç½®ç•Œé¢

          æœ¬ç‰ˆæœ¬æ”¯æŒé€šè¿‡ Web ç•Œé¢é…ç½®ç¯å¢ƒå˜é‡ï¼š

          1. éƒ¨ç½²æˆåŠŸåè®¿é—®ï¼š`http://your-domain:3000/config`
          2. åœ¨ Web ç•Œé¢ä¿®æ”¹ç¯å¢ƒå˜é‡
          3. ä¿å­˜é…ç½®åé‡å¯å®¹å™¨ä½¿é…ç½®ç”Ÿæ•ˆ

          ### ğŸ“ æ”¯æŒçš„ç¯å¢ƒå˜é‡

          - `UPLOAD_URL` - èŠ‚ç‚¹ä¸Šä¼ åœ°å€
          - `PROJECT_URL` - é¡¹ç›® URL
          - `UUID` - ç”¨æˆ·å”¯ä¸€æ ‡è¯†
          - `NEZHA_SERVER` - å“ªå’æœåŠ¡å™¨åœ°å€
          - `NEZHA_PORT` - å“ªå’ç«¯å£
          - `NEZHA_KEY` - å“ªå’å¯†é’¥
          - `ARGO_DOMAIN` - Argo åŸŸå
          - `ARGO_AUTH` - Argo è®¤è¯
          - `CFIP` - CF ä¼˜é€‰ IP
          - `CFPORT` - CF ä¼˜é€‰ç«¯å£
          - `NAME` - èŠ‚ç‚¹åç§°

          ### ğŸ“š æ›´å¤šä¿¡æ¯

          æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}) äº†è§£è¯¦ç»†ä½¿ç”¨è¯´æ˜ã€‚
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            dist/nodejs-argo-${{ steps.version.outputs.VERSION }}.tar.gz
            dist/nodejs-argo-${{ steps.version.outputs.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest tag
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -f latest
          git push -f origin latest
