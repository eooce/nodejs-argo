name: Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Build standalone executables (like JAR files)
        run: |
          # Install pkg globally
          npm install -g pkg

          # Create output directory
          mkdir -p dist/binaries

          # Build executables for different platforms
          pkg . --targets node18-linux-x64,node18-macos-x64,node18-win-x64 --compress GZip --output dist/binaries/nodejs-argo

          # Rename executables with proper extensions and version
          cd dist/binaries
          mv nodejs-argo-linux nodejs-argo-${{ steps.version.outputs.VERSION }}-linux-x64
          mv nodejs-argo-macos nodejs-argo-${{ steps.version.outputs.VERSION }}-macos-x64
          mv nodejs-argo-win.exe nodejs-argo-${{ steps.version.outputs.VERSION }}-windows-x64.exe

          # Create checksums
          sha256sum nodejs-argo-* > SHA256SUMS.txt

          cd ../..

      - name: Create distribution package
        run: |
          # Create source package
          mkdir -p dist/source/nodejs-argo-${{ steps.version.outputs.VERSION }}
          cp -r index.js package.json Dockerfile LICENSE README.md dist/source/nodejs-argo-${{ steps.version.outputs.VERSION }}/

          cd dist/source
          tar -czf ../nodejs-argo-${{ steps.version.outputs.VERSION }}-source.tar.gz nodejs-argo-${{ steps.version.outputs.VERSION }}
          zip -r ../nodejs-argo-${{ steps.version.outputs.VERSION }}-source.zip nodejs-argo-${{ steps.version.outputs.VERSION }}
          cd ../..

      - name: Generate release notes
        id: release_notes
        run: |
          cat << 'EOF' > release_notes.md
          ## ğŸš€ Release ${{ steps.version.outputs.VERSION }}

          ### ğŸ“¦ ä¸‹è½½ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ¨è - ç±»ä¼¼ JAR ä½¿ç”¨æ–¹å¼ï¼‰

          **æ— éœ€å®‰è£… Node.js ç¯å¢ƒï¼** ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶å³å¯ç›´æ¥è¿è¡Œï¼š

          #### Linux (x64)
          ```bash
          # ä¸‹è½½
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/nodejs-argo-${{ steps.version.outputs.VERSION }}-linux-x64

          # æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x nodejs-argo-${{ steps.version.outputs.VERSION }}-linux-x64

          # è¿è¡Œï¼ˆç±»ä¼¼ java -jar çš„ä½¿ç”¨æ–¹å¼ï¼‰
          ./nodejs-argo-${{ steps.version.outputs.VERSION }}-linux-x64
          ```

          #### macOS (x64)
          ```bash
          # ä¸‹è½½
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/nodejs-argo-${{ steps.version.outputs.VERSION }}-macos-x64

          # æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x nodejs-argo-${{ steps.version.outputs.VERSION }}-macos-x64

          # è¿è¡Œ
          ./nodejs-argo-${{ steps.version.outputs.VERSION }}-macos-x64
          ```

          #### Windows (x64)
          ```powershell
          # ä¸‹è½½åç›´æ¥åŒå‡»è¿è¡Œï¼Œæˆ–åœ¨å‘½ä»¤è¡Œæ‰§è¡Œï¼š
          .\nodejs-argo-${{ steps.version.outputs.VERSION }}-windows-x64.exe
          ```

          ### ğŸ³ ä½¿ç”¨ Docker
          ```bash
          docker pull ghcr.io/${{ github.repository_owner }}/nodejs:latest
          docker run -d -p 3000:3000 \
            -e UUID=your-uuid \
            -e NEZHA_SERVER=your-server \
            -e NEZHA_KEY=your-key \
            -v $(pwd)/data:/tmp \
            ghcr.io/${{ github.repository_owner }}/nodejs:latest
          ```

          ### ğŸ“ ä½¿ç”¨æºç å®‰è£…
          ```bash
          # ä¸‹è½½å¹¶è§£å‹æºç åŒ…
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/nodejs-argo-${{ steps.version.outputs.VERSION }}-source.tar.gz
          tar -xzf nodejs-argo-${{ steps.version.outputs.VERSION }}-source.tar.gz
          cd nodejs-argo-${{ steps.version.outputs.VERSION }}

          # å®‰è£…ä¾èµ–å¹¶è¿è¡Œ
          npm install
          npm start
          ```

          ### ğŸ”§ Web é…ç½®ç•Œé¢

          **æ–°åŠŸèƒ½ï¼** æœ¬ç‰ˆæœ¬æ”¯æŒé€šè¿‡ Web ç•Œé¢é…ç½®ç¯å¢ƒå˜é‡ï¼š

          1. å¯åŠ¨åº”ç”¨åè®¿é—®ï¼š`http://localhost:3000/config`
          2. åœ¨ Web ç•Œé¢ä¿®æ”¹ç¯å¢ƒå˜é‡
          3. ä¿å­˜é…ç½®åˆ° `./tmp/.env` æ–‡ä»¶
          4. é‡å¯åº”ç”¨ä½¿é…ç½®ç”Ÿæ•ˆï¼ˆé…ç½®ä¼šè‡ªåŠ¨åŠ è½½ï¼‰

          ### ğŸ“ æ”¯æŒçš„ç¯å¢ƒå˜é‡

          | å˜é‡å | è¯´æ˜ |
          |--------|------|
          | `UUID` | ç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼ˆå¿…å¡«ï¼‰ |
          | `NEZHA_SERVER` | å“ªå’æœåŠ¡å™¨åœ°å€ |
          | `NEZHA_PORT` | å“ªå’ç«¯å£ï¼ˆv0 éœ€è¦ï¼‰ |
          | `NEZHA_KEY` | å“ªå’å¯†é’¥ |
          | `ARGO_DOMAIN` | Argo å›ºå®šéš§é“åŸŸå |
          | `ARGO_AUTH` | Argo è®¤è¯ä¿¡æ¯ |
          | `CFIP` | CF ä¼˜é€‰ IP/åŸŸå |
          | `CFPORT` | CF ä¼˜é€‰ç«¯å£ |
          | `UPLOAD_URL` | èŠ‚ç‚¹ä¸Šä¼ åœ°å€ |
          | `PROJECT_URL` | é¡¹ç›® URL |
          | `NAME` | èŠ‚ç‚¹åç§° |

          ### ğŸ“‚ Release èµ„äº§è¯´æ˜

          - **ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶**ï¼šæ— éœ€ Node.js ç¯å¢ƒï¼Œä¸‹è½½å³å¯è¿è¡Œï¼ˆç±»ä¼¼ JAR åŒ…ï¼‰
            - `nodejs-argo-*-linux-x64` - Linux 64ä½å¯æ‰§è¡Œæ–‡ä»¶
            - `nodejs-argo-*-macos-x64` - macOS 64ä½å¯æ‰§è¡Œæ–‡ä»¶
            - `nodejs-argo-*-windows-x64.exe` - Windows 64ä½å¯æ‰§è¡Œæ–‡ä»¶
          - **æºç åŒ…**ï¼šéœ€è¦ Node.js ç¯å¢ƒ
            - `nodejs-argo-*-source.tar.gz` - æºç åŒ…ï¼ˆtar.gzï¼‰
            - `nodejs-argo-*-source.zip` - æºç åŒ…ï¼ˆzipï¼‰
          - **æ ¡éªŒæ–‡ä»¶**ï¼š
            - `SHA256SUMS.txt` - SHA256 æ ¡éªŒå’Œ

          ### ğŸ” æ–‡ä»¶æ ¡éªŒ

          ä¸‹è½½åè¯·éªŒè¯ SHA256 æ ¡éªŒå’Œï¼š
          ```bash
          sha256sum -c SHA256SUMS.txt
          ```

          ### ğŸ“š æ›´å¤šä¿¡æ¯

          æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}) äº†è§£è¯¦ç»†ä½¿ç”¨è¯´æ˜ã€‚

          ---

          **æ³¨æ„**ï¼šç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶åŒ…å«äº†å®Œæ•´çš„ Node.js è¿è¡Œæ—¶å’Œåº”ç”¨ä»£ç ï¼Œæ–‡ä»¶è¾ƒå¤§ï¼ˆçº¦ 50-70MBï¼‰ï¼Œä½†ä½¿ç”¨æœ€æ–¹ä¾¿ï¼Œæ— éœ€ä»»ä½•ä¾èµ–ã€‚
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            dist/binaries/nodejs-argo-${{ steps.version.outputs.VERSION }}-linux-x64
            dist/binaries/nodejs-argo-${{ steps.version.outputs.VERSION }}-macos-x64
            dist/binaries/nodejs-argo-${{ steps.version.outputs.VERSION }}-windows-x64.exe
            dist/binaries/SHA256SUMS.txt
            dist/nodejs-argo-${{ steps.version.outputs.VERSION }}-source.tar.gz
            dist/nodejs-argo-${{ steps.version.outputs.VERSION }}-source.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest tag
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -f latest
          git push -f origin latest
